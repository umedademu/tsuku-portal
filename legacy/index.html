<!DOCTYPE html>
<html lang="ja">
<head>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-T5X8G7JF');</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="<?= metaDescription ?>">
  <meta name="google-site-verification" content="okCIY7K6T-ILt_f8XHrjXd9ww73s1SxKTCZmL9rxWBs" />

<?
// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å‡¦ç† (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
const rawCaseStudies = JSON.parse(caseStudies || '[]');
const rawSeoPages = JSON.parse(seoPages || '[]');
const usageStatsData = JSON.parse(usageStats || '{}');

const safeCaseStudies = Array.isArray(rawCaseStudies) ? rawCaseStudies : [];

const seoPagesError = rawSeoPages.error ? rawSeoPages.message : null;
const seoPagesDiagnosticCode = rawSeoPages.diagnosticCode || null;
const safeSeoPages = (!seoPagesError && Array.isArray(rawSeoPages)) ? rawSeoPages : [];

const caseStudiesError = rawCaseStudies.error ? rawCaseStudies.message : null;

let currentSeoPage = null;
let currentCaseStudy = null;

let canonicalUrl = baseUrl;
let pageType = 'website';
let breadcrumbs = [{name: 'HOME', url: baseUrl}];

if (pageId && pageId.startsWith('seo_')) {
  pageType = 'article';
  const seoId = pageId.substring(4);
  currentSeoPage = safeSeoPages.find(s => s.id === seoId);
  if (currentSeoPage) {
    canonicalUrl = `${baseUrl}?page=seo_${currentSeoPage.id}`;
    breadcrumbs.push({name: currentSeoPage.pageTitle, url: canonicalUrl});
  }
} else if (pageId && pageId.startsWith('case_')) {
  pageType = 'article';
  const docId = pageId.substring(5);
  currentCaseStudy = safeCaseStudies.find(c => c.id === docId);
  if (currentCaseStudy) {
    canonicalUrl = `${baseUrl}?page=case_${currentCaseStudy.id}`;
    breadcrumbs.push({name: 'æ–½å·¥äº‹ä¾‹ä¸€è¦§', url: `${baseUrl}?page=list`});
    breadcrumbs.push({name: currentCaseStudy.title, url: canonicalUrl});
  }
} else if (pageId === 'list') {
  canonicalUrl = `${baseUrl}?page=list`;
  breadcrumbs.push({name: 'æ–½å·¥äº‹ä¾‹ä¸€è¦§', url: canonicalUrl});
}
?>

  <link rel="canonical" href="<?= canonicalUrl ?>" />
  <meta property="og:title" content="<?= pageTitle ?>" />
  <meta property="og:description" content="<?= metaDescription ?>" />
  <meta property="og:type" content="<?= pageType ?>" />
  <meta property="og:url" content="<?= canonicalUrl ?>" />
  <meta property="og:site_name" content="<?= businessInfo.name ?>" />
  <meta property="og:locale" content="ja_JP" />
  <? if (ogImageUrl) { ?>
  <meta property="og:image" content="<?= ogImageUrl ?>" />
  <? } ?>

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<?= pageTitle ?>" />
  <meta name="twitter:description" content="<?= metaDescription ?>" />
  <? if (ogImageUrl) { ?>
  <meta name="twitter:image" content="<?= ogImageUrl ?>" />
  <? } ?>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>

  <style>
/* PHOENIX v5.1: ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© */

/* --- CSS Variables & Base (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) --- */
:root {
  --color-primary-dark: #1a1a2e;
  --color-primary-blue: #0f3460;
  --color-secondary: #16213e;
  --color-accent-gold: #ffd700;
  --color-secondary-red: #e94c3c;
  --color-background: #f8f9fa;
  --color-surface: white;
  --color-text-dark: #333;
  --color-text-light: white;
  --color-chat-bg: #f1f3f5;
  --color-chat-user: #007bff;
  --color-chat-ai: #ffffff;
  --color-chat-border: #dee2e6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Noto Sans JP', sans-serif;
  line-height: 1.6;
  color: var(--color-text-dark);
  background: var(--color-background);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
.section { padding: 80px 0; }
a { text-decoration: none; color: inherit; }

/* Header & Main (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.header {
  background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-secondary) 100%);
  color: var(--color-text-light);
  padding: 15px 0;
  position: sticky;
  top: 0;
  z-index: 999;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.header-content { display: flex; justify-content: space-between; align-items: center; }
.logo { font-size: 24px; font-weight: 900; color: var(--color-accent-gold); }
.nav-menu { display: flex; list-style: none; gap: 30px; }
.nav-menu a { color: var(--color-text-light); transition: color 0.3s; }
.nav-menu a:hover { color: var(--color-accent-gold); }
.main-content { flex: 1; }

/* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.breadcrumbs-container { background-color: var(--color-background); padding-top: 20px; }
.breadcrumbs { font-size: 0.9rem; color: #666; }
.breadcrumbs a { color: var(--color-primary-blue); text-decoration: none; }
.breadcrumbs a:hover { text-decoration: underline; }
.breadcrumbs span.separator { margin: 0 8px; }

/* Hero Section (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.hero {
  background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-secondary) 100%);
  color: var(--color-text-light);
  text-align: center;
  position: relative;
  padding: 100px 0;
}
.system-badge {
  background: rgba(255, 255, 255, 0.1);
  color: var(--color-text-light);
  padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 500;
  display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px;
}
.hero h1 { font-size: clamp(32px, 5vw, 52px); font-weight: 900; margin-bottom: 25px; line-height: 1.3; }
.hero h1 .highlight { color: var(--color-accent-gold); }
.hero p { font-size: 18px; margin-bottom: 40px; opacity: 0.9; }
.action-buttons { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; margin: 50px 0 30px; }

/* ç·Šæ€¥æ€§è¡¨ç¤º (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.urgency-bar {
  background: var(--color-secondary-red);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  display: inline-block;
  font-weight: 700;
  margin-top: 20px;
  box-shadow: 0 4px 15px rgba(233, 76, 60, 0.4);
}
.urgency-bar .highlight {
  color: var(--color-accent-gold);
  font-size: 1.2em;
}

/* Buttons (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.btn {
  padding: 18px 35px; border: none; border-radius: 50px; font-size: 18px; font-weight: 700;
  cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: inline-flex; align-items: center;
  gap: 10px; min-width: 280px; justify-content: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  transform: perspective(1px) translateZ(0);
}
.btn:hover {
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  transform: translateY(-3px);
}
.btn:active {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.btn-primary { background: var(--color-accent-gold); color: var(--color-primary-dark); }
.btn-primary:hover { background: #ffed4e; }
.btn-secondary { background: var(--color-secondary-red); color: var(--color-text-light); }
.btn-secondary:hover { background: #c0392b; }
.btn-outline { background: transparent; color: var(--color-text-light); border: 2px solid var(--color-accent-gold); }
.btn-outline:hover { background: var(--color-accent-gold); color: var(--color-primary-dark); }
.btn-text { color: var(--color-primary-blue); font-weight: 500; box-shadow: none; padding: 5px; min-width: auto; }
.btn-text:hover { text-decoration: underline; transform: none; box-shadow: none; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

/* Sections (Why AI, Works) (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.why-ai { background: var(--color-surface); }
.works-section { background: var(--color-background); }
.section-title { text-align: center; font-size: 36px; font-weight: 700; margin-bottom: 20px; color: var(--color-primary-dark); }
.section-subtitle { text-align: center; font-size: 18px; color: #666; margin-bottom: 60px; }

.features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; margin-top: 60px; }
.feature-card { text-align: center; padding: 40px 20px; border-radius: 12px; background: var(--color-background); transition: transform 0.3s, box-shadow 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
.feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
.feature-icon {
  width: 80px; height: 80px; background: linear-gradient(135deg, var(--color-secondary-red), #c0392b);
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  margin: 0 auto 20px; font-size: 32px; color: white;
}
.feature-card h3 { font-size: 24px; font-weight: 700; margin-bottom: 15px; }

/* å°‚é–€å®¶ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.expert-section {
  background: var(--color-surface);
}
.expert-profile {
  display: flex;
  align-items: center;
  gap: 50px;
  max-width: 900px;
  margin: 0 auto;
}
.expert-image img {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.expert-bio h3 {
  font-size: 28px;
  color: var(--color-primary-blue);
  margin-bottom: 10px;
}
.expert-title {
  font-size: 18px;
  color: #666;
  margin-bottom: 20px;
}
.expert-credentials {
  margin-top: 20px;
  font-size: 14px;
  color: #888;
}

/* æ–½å·¥äº‹ä¾‹ï¼ˆWorks/Blogï¼‰ã‚¹ã‚¿ã‚¤ãƒ« (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.blog-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
.blog-card {
  background-color: var(--color-surface); border-radius: 10px; overflow: hidden;
  transition: transform 0.3s; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.blog-card:hover { transform: translateY(-5px); }
.blog-card-image { width: 100%; height: 200px; object-fit: cover; }
.blog-card-image-placeholder {
  width: 100%; height: 200px; background-color: #eee; display: flex;
  align-items: center; justify-content: center; color: #999;
}
.blog-card-content { padding: 25px; flex-grow: 1; }
.blog-card h3 { font-size: 1.4rem; margin-bottom: 15px; color: var(--color-primary-blue); }
.blog-card-meta { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; }
.blog-list-link { text-align: center; margin-top: 50px; }

/* è©³ç´°ãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.detail-page { background-color: var(--color-background); }
.detail-container {
  max-width: 900px; margin: 0 auto; background-color: var(--color-surface);
  padding: 50px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.detail-header h1 { font-size: 2.5rem; margin-bottom: 20px; }
.detail-meta { color: #666; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
.detail-body { margin-bottom: 50px; }

/* Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”±æ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.doc-img { max-width: 100%; height: auto; margin: 30px 0; border-radius: 8px; display: block; }
.doc-h2 { font-size: 2rem; color: var(--color-primary-blue); margin-top: 60px; border-bottom: 2px solid var(--color-primary-blue); padding-bottom: 10px; }
.doc-h3 { font-size: 1.5rem; color: var(--color-primary-dark); margin-top: 40px; }
.doc-p { margin-bottom: 20px; }
.doc-li { margin-left: 20px; margin-bottom: 10px; }

/* 404 */
.notfound-section { text-align: center; min-height: 50vh; display: flex; flex-direction: column; justify-content: center; }

/* Footer (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.footer { background-color: var(--color-primary-dark); color: #aaa; padding: 60px 0 20px; font-size: 0.9rem; margin-top: 40px; }
.footer-content {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 30px;
  text-align: left;
}
.footer-section {
  flex: 1;
  min-width: 200px;
}
.footer-section h4 {
  color: var(--color-text-light);
  font-size: 1.2rem;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--color-accent-gold);
  padding-bottom: 5px;
}
.footer-links {
  list-style: none;
}
.footer-links li {
  margin-bottom: 10px;
}
.footer-links a {
  color: #aaa;
  transition: color 0.3s;
}
.footer-links a:hover {
  color: var(--color-accent-gold);
}

/* SNSãƒªãƒ³ã‚¯ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.social-links {
  display: flex;
  gap: 20px;
  /* margin-top: 20px; (é…ç½®å ´æ‰€ã«ã‚ˆã‚Šèª¿æ•´) */
}
.social-links a {
  font-size: 24px;
  color: #aaa;
  transition: color 0.3s;
}
.social-links a:hover {
  color: var(--color-accent-gold);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨SNSãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
.header-social-links a {
  color: var(--color-text-light);
}
.header-social-links a:hover {
  color: var(--color-accent-gold);
}


.footer-bottom {
  text-align: center;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid #333;
}

/* --- AI Chat & Inquiry Dialog (Modal) --- */
/* ã€v5.1 FIXã€‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€Flexboxã®æ§‹é€ ã‚’å†ç¢ºèª */

.ai-dialog {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  z-index: 1001;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.ai-dialog.active {
  display: flex;
}

.dialog-content {
  background: var(--color-surface);
  border-radius: 12px;
  max-width: 800px;
  width: 100%;
  height: 90vh; /* é«˜ã•ã‚’å›ºå®š */
  max-height: 800px; /* æœ€å¤§é«˜ã•ã‚’è¨­å®š */
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.dialog-header {
  background: linear-gradient(135deg, var(--color-primary-dark), var(--color-secondary));
  color: var(--color-text-light);
  padding: 20px 30px;
  flex-shrink: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ç¸®ã¾ãªã„ */
  position: relative;
}
.close-dialog {
  position: absolute;
  top: 15px;
  right: 20px;
  background: none;
  border: none;
  color: var(--color-text-light);
  font-size: 24px;
  cursor: pointer;
}

.dialog-body {
  display: flex;
  flex-direction: column;
  flex-grow: 1; /* ãƒœãƒ‡ã‚£ãŒæ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
  overflow: hidden; /* ãƒœãƒ‡ã‚£è‡ªä½“ã¯ã¯ã¿å‡ºã•ãªã„ */
}

/* ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
.chat-stage {
  display: none;
  flex-direction: column;
  height: 100%; /* ã‚¹ãƒ†ãƒ¼ã‚¸ãŒãƒœãƒ‡ã‚£ã®é«˜ã•ã„ã£ã±ã„ã«ãªã‚‹ */
  overflow: hidden; /* ã‚¹ãƒ†ãƒ¼ã‚¸è‡ªä½“ã¯ã¯ã¿å‡ºã•ãªã„ */
}
.chat-stage.active {
  display: flex;
}

/* --- Stage 1 & 2 (Initial, Socrates) --- */
/* ã“ã‚Œã‚‰ã¯å†…å®¹ãŒå°‘ãªã„ãŸã‚ã€è‡ªèº«ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
#stage-initial, #stage-socrates, #stage-inquiry {
  padding: 30px;
  overflow-y: auto;
}

/* ã€T401: SOCRATESã€‘Stage 2: Strategic Question (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.socrates-options {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}
.socrates-btn {
  text-align: left;
  justify-content: flex-start;
  padding: 20px;
  border-radius: 8px;
  background-color: var(--color-chat-bg);
  border: 1px solid var(--color-chat-border);
  transition: all 0.3s;
  box-shadow: none;
  min-width: 100%;
}
.socrates-btn:hover {
  border-color: var(--color-primary-blue);
  background-color: #e9ecef;
  transform: none;
  box-shadow: none;
}
.socrates-btn h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 5px;
}
.socrates-btn p {
  font-size: 14px;
  color: #666;
}


/* å…±é€šå…¥åŠ›ã‚¹ã‚¿ã‚¤ãƒ« (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.form-group { margin-bottom: 25px; }
label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-dark); }
input[type="text"], input[type="email"], input[type="tel"], textarea {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid var(--color-chat-border);
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
}
textarea { min-height: 120px; resize: vertical; }

/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠUI (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.file-input-wrapper {
  border: 2px dashed var(--color-chat-border);
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.3s;
  background-color: var(--color-chat-bg);
}
.file-input-wrapper:hover { border-color: var(--color-primary-blue); }
#fileInput { display: none; }


/* --- Stage 3: Chat Session --- */
/* ã€v5.1 FIXã€‘ãƒãƒ£ãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ã®Flexboxæ§‹é€ ã‚’ä¿®æ­£ */
#stage-chat {
  display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
}

#stage-chat.active {
  display: flex;
  flex-direction: column;
}

/* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
.chat-messages {
  flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
  overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
  padding: 30px;
  background-color: var(--color-chat-bg);
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; white-space: pre-wrap; }
.message-user { align-self: flex-end; background-color: var(--color-chat-user); color: var(--color-text-light); border-bottom-right-radius: 4px; }
.message-ai { align-self: flex-start; background-color: var(--color-chat-ai); color: var(--color-text-dark); border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.message-system { align-self: center; text-align: center; font-size: 13px; color: #6c757d; background: transparent; padding: 5px 0; }

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.loading-indicator { align-self: flex-start; display: flex; align-items: center; padding: 10px 15px; }
.dot { height: 8px; width: 8px; background-color: #999; border-radius: 50%; display: inline-block; margin-right: 5px; animation: bounce 1.4s infinite ease-in-out both; }
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

/* ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ */
.chat-input-area {
  flex-shrink: 0; /* å…¥åŠ›ã‚¨ãƒªã‚¢ã¯ç¸®ã¾ãªã„ */
  padding: 20px 30px;
  border-top: 1px solid var(--color-chat-border);
  background-color: var(--color-surface);
  display: flex; gap: 15px; align-items: center;
}
#chatInput { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--color-chat-border); border-radius: 25px; font-size: 14px; }
.send-btn { background-color: var(--color-chat-user); color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; transition: background-color 0.3s; box-shadow: none; min-width: auto;}
.send-btn:hover:not(:disabled) { background-color: #0056b3; }
.send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

.chat-footer {
  flex-shrink: 0; /* ãƒ•ãƒƒã‚¿ãƒ¼ã¯ç¸®ã¾ãªã„ */
  padding: 15px 30px; text-align: center; border-top: 1px solid var(--color-chat-border); background-color: var(--color-surface);
}

/* ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.positive-feedback {
  background: #d4edda;
  color: #155724;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  text-align: center;
  font-weight: 600;
  display: none;
  border: 1px solid #c3e6cb;
}

/* --- Stage 4: Inquiry Form --- */
textarea[readonly] { background-color: var(--color-background); }

/* Status Messages (Error, Success) (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
.status-message.error, .admin-warning {
  background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #f5c6cb; line-height: 1.4;
}
.status-message.success {
  background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #c3e6cb; text-align: center;
}

/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°CTA (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
#floating-cta {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
  transform: translateY(50px);
}
#floating-cta.visible {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}
#floating-cta .btn {
  min-width: auto;
  padding: 20px;
  border-radius: 50%;
  font-size: 24px;
}

/* é›¢è„±é˜²æ­¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */
#exit-intent-popup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  z-index: 1002;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.popup-content {
  background: white;
  padding: 40px;
  border-radius: 12px;
  max-width: 600px;
  text-align: center;
  position: relative;
}
.popup-close {
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  background: none;
  border: none;
}
.popup-content h2 {
  /* color: var(--color-secondary-red); (v5.1ã§å‰Šé™¤) */
  color: var(--color-primary-blue);
  margin-bottom: 20px;
}


/* Responsive */
@media (max-width: 768px) {
  .header-content { flex-direction: column; gap: 15px; }
  .nav-menu { flex-direction: row; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
  .action-buttons { flex-direction: column; align-items: center; gap: 20px; }
  .btn { width: 100%; max-width: 350px; }
  .features-grid, .blog-list { grid-template-columns: 1fr; }

  /* å°‚é–€å®¶ç´¹ä»‹ */
  .expert-profile {
    flex-direction: column;
    text-align: center;
    gap: 30px;
  }

  /* ãƒ•ãƒƒã‚¿ãƒ¼ */
  .footer-content {
    flex-direction: column;
    text-align: center;
  }
  .social-links {
    justify-content: center;
    margin-top: 15px;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°èª¿æ•´ */
  .ai-dialog { padding: 0; }
  .dialog-content {
    height: 100vh; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å…¨ç”»é¢ */
    max-height: 100vh;
    border-radius: 0;
  }
  .dialog-header { border-radius: 0; padding: 15px 20px; }
  #stage-initial, #stage-inquiry, .chat-messages, #stage-socrates { padding: 20px; }
  .chat-input-area, .chat-footer { padding: 15px 20px; }

  .detail-container { padding: 20px; }
  .detail-header h1 { font-size: 1.8rem; }
  .doc-h2 { font-size: 1.5rem; }

  .breadcrumbs-container { padding-top: 15px; }
  .breadcrumbs { font-size: 0.8rem; }

  /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°CTA */
  #floating-cta .btn {
    padding: 15px;
    font-size: 20px;
  }
}
</style>
</head>
<body data-ai-prompts="<?= aiPrompts ?>" data-diagnostic-info="<?= diagnosticInfo ?>">
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T5X8G7JF"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="<?= baseUrl ?>" class="logo"><?= businessInfo.name ?></a>
        <nav>
          <ul class="nav-menu">
            <li><a href="<?= baseUrl ?>#why-ai">é¸ã°ã‚Œã‚‹ç†ç”±</a></li>
            <li><a href="<?= baseUrl ?>?page=list">æ–½å·¥äº‹ä¾‹</a></li>
            <li><a href="#expert-profile">å°‚é–€å®¶ç´¹ä»‹</a></li>
            <li><a href="#hero-cta-anchor" class="btn btn-primary" style="padding: 8px 16px; min-width: auto; box-shadow: none; font-size: 16px;">ç„¡æ–™è¨ºæ–­é–‹å§‹</a></li>
          </ul>
          <div class="social-links header-social-links" style="margin-top: 0;">
            <a href="https://www.instagram.com/kensetusentai/" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://www.tiktok.com/@tsukurunja" target="_blank" rel="noopener noreferrer" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
            <a href="https://line.me/ti/p/~kensetusentai88612" target="_blank" rel="noopener noreferrer" aria-label="LINE"><i class="fab fa-line"></i></a>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <main class="main-content">

    <? /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? if (pageId && pageId !== 'home' && pageId !== 'notfound' && breadcrumbs.length > 1) { ?>
    <div class="breadcrumbs-container">
      <div class="container breadcrumbs">
        <? breadcrumbs.forEach((crumb, index) => { ?>
          <? if (index < breadcrumbs.length - 1) { ?>
            <a href="<?= crumb.url ?>"><?= crumb.name ?></a><span class="separator">></span>
          <? } else { ?>
            <?= crumb.name ?>
          <? } ?>
        <? }); ?>
      </div>
    </div>
    <? } ?>


    <? /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? if (seoPagesError) { ?>
    <div class="container" style="padding-top: 20px;">
      <div class="admin-warning">
        <strong>ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å‘ã‘è­¦å‘Šï¼šSEOè¨ºæ–­ã€‘</strong> SEOãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br>
        <? if (seoPagesDiagnosticCode === 'NO_PUBLISHED_ROWS' || seoPagesDiagnosticCode === 'SHEET_EMPTY') { ?>
          <strong>åŸå› ï¼š</strong>ã‚·ãƒ¼ãƒˆã€Œseo_pagesã€å†…ã«ã€Båˆ—ã®StatusãŒã€Œpublishedã€ã«ãªã£ã¦ã„ã‚‹æœ‰åŠ¹ãªè¡ŒãŒ1ä»¶ã‚‚å­˜åœ¨ã—ã¾ã›ã‚“ã€‚<br>
          <strong>å¯¾å‡¦æ³•ï¼š</strong>ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’ç¢ºèªã—ã€å…¬é–‹ã—ãŸã„è¡Œã®Båˆ—(Status)ã‚’åŠè§’è‹±å°æ–‡å­—ã§ã€Œpublishedã€ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
        <? } else { ?>
          <strong>åŸå› ï¼š</strong>ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(Code: <?= seoPagesDiagnosticCode ?>)<br>
          <strong>å¯¾å‡¦æ³•ï¼š</strong><?= seoPagesError ?>
        <? } ?>
      </div>
    </div>
    <? } ?>


    <? /* æ–½å·¥äº‹ä¾‹ä¸€è¦§ãƒšãƒ¼ã‚¸ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? if (pageId === 'list') { ?>
      <section class="works-section section" id="works-list">
        <div class="container">
          <h1 class="section-title">æ–½å·¥äº‹ä¾‹ä¸€è¦§</h1>
          <? if (caseStudiesError) { ?>
            <div class="admin-warning">
              <strong>ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å‘ã‘è­¦å‘Šã€‘</strong> æ–½å·¥äº‹ä¾‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small><?= caseStudiesError ?></small>
            </div>
          <? } ?>
          <div class="blog-list">
            <? safeCaseStudies.forEach(article => { ?>
              <a href="<?= baseUrl ?>?page=case_<?= article.id ?>" class="blog-card">
                <? if (article.thumbnailUrl) { ?>
                  <img src="<?= article.thumbnailUrl ?>" alt="<?= article.title ?>ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ" class="blog-card-image" loading="lazy">
                <? } else { ?>
                  <div class="blog-card-image-placeholder"><i class="fas fa-hard-hat"></i></div>
                <? } ?>
                <div class="blog-card-content">
                  <p class="blog-card-meta"><?= article.date ?> | <?= article.region ?></p>
                  <h3><?= article.title ?></h3>
                  <p><?= article.description ?></p>
                </div>
              </a>
            <? }); ?>
          </div>
          <? if (safeCaseStudies.length === 0 && !caseStudiesError) { ?>
            <p style="text-align: center; margin-top: 50px;">æ–½å·¥äº‹ä¾‹ã‚’æº–å‚™ä¸­ã§ã™ã€‚</p>
          <? } ?>
        </div>
      </section>

    <? /* æ–½å·¥äº‹ä¾‹è©³ç´°ãƒšãƒ¼ã‚¸ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? } else if (pageId && pageId.startsWith('case_')) { ?>
      <?
      if (currentCaseStudy) {
      ?>
      <div class="detail-page section">
        <div class="container detail-container">
          <article>
            <header class="detail-header">
              <h1><?= currentCaseStudy.title ?></h1>
              <p class="detail-meta">å…¬é–‹æ—¥: <?= currentCaseStudy.date ?> | åœ°åŸŸ: <?= currentCaseStudy.region ?> | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <?= currentCaseStudy.keywords ?></p>
            </header>
            <div class="detail-body">
              <?!= currentCaseStudy.content ?>
            </div>
            <a href="<?= baseUrl ?>?page=list" class="btn-text">Â« æ–½å·¥äº‹ä¾‹ä¸€è¦§ã«æˆ»ã‚‹</a>
          </article>
        </div>
      </div>
      <? } ?>

    <? /* SEOè©³ç´°ãƒšãƒ¼ã‚¸ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? } else if (pageId && pageId.startsWith('seo_')) { ?>
      <?
      if (currentSeoPage) { ?>
      <div class="detail-page section">
        <div class="container detail-container">
          <article>
            <header class="detail-header">
              <h1><?= currentSeoPage.h1 ?></h1>
            </header>
            <div class="detail-body">
              <?!= currentSeoPage.mainContent ?>

              <div style="background-color: var(--color-chat-bg); padding: 30px; border-radius: 8px; margin-top: 50px;">
                <h2 class="doc-h2" style="margin-top: 0;">å¯¾å¿œåœ°åŸŸè©³ç´°ã¨ä¼šç¤¾æƒ…å ±</h2>
                <p><?= currentSeoPage.MEO_strengthener ?></p>
                <p>
                  <strong><?= businessInfo.name ?></strong><br>
                  ã€’<?= businessInfo.address.postalCode ?> <?= businessInfo.address.addressRegion ?><?= businessInfo.address.addressLocality ?><?= businessInfo.address.streetAddress ?><br>
                  TEL: <?= businessInfo.telephone ?>
                </p>
              </div>

              <? if (currentSeoPage.relatedCaseStudyId) { ?>
                <h2 class="doc-h2">é–¢é€£ã™ã‚‹æ–½å·¥äº‹ä¾‹</h2>
                <p><a href="<?= baseUrl ?>?page=case_<?= currentSeoPage.relatedCaseStudyId ?>" class="btn-text">é–¢é€£äº‹ä¾‹ã‚’è¦‹ã‚‹</a></p>
              <? } ?>
            </div>
            <div style="margin-top: 40px; text-align: center;">
              <a href="<?= baseUrl ?>#hero-cta-anchor" class="btn btn-primary"><?= currentSeoPage.targetKeyword ?>ã«ã¤ã„ã¦è¨ºæ–­é–‹å§‹</a>
            </div>
          </article>
        </div>
      </div>
      <? } ?>

    <? /* 404ãƒšãƒ¼ã‚¸ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) */ ?>
    <? } else if (pageId === 'notfound') { ?>
      <section class="section">
        <div class="container notfound-section">
          <h1>ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)</h1>
          <p>ãŠæ¢ã—ã®ãƒšãƒ¼ã‚¸ã¯å­˜åœ¨ã—ãªã„ã‹ã€ç§»å‹•ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
          <div style="margin-top: 30px;">
            <a href="<?= baseUrl ?>" class="btn btn-primary">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
          </div>
        </div>
      </section>

    <? /* ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */ ?>
    <? } else { ?>

      <div id="hero-cta-anchor"></div>
      <section class="hero section">
        <div class="container">
          <div class="hero-content">
            <div class="system-badge">
              <i class="fas fa-brain"></i>
              Googleæœ€æ–°AIã€ŒGemini 2.5 Proã€æ­è¼‰è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ 
            </div>

            <h1>
              ãã®è¦‹ç©ã‚‚ã‚Šå†…å®¹ã€<span class="highlight">æœ¬å½“ã«é©æ­£ã§ã™ã‹ï¼Ÿ</span>
            </h1>
            <p>å¥‘ç´„ã‚’æ±ºã‚ã‚‹å‰ã«ã€‚å½“ç¤¾ã®AIãŒã€ãŠæ‰‹å…ƒã®è¦‹ç©ã‚‚ã‚Šã‚„å›³é¢ã«æ½œã‚€<br>ã€Œã‚³ã‚¹ãƒˆã¨å®‰å…¨æ€§ã®ãƒªã‚¹ã‚¯ã€ã‚’ç„¡æ–™ã§<strong>è¨ºæ–­ãƒ»æ˜ç¢ºåŒ–</strong>ã—ã¾ã™ã€‚</p>

            <div class="action-buttons">
              <button class="btn btn-primary specialist-btn" data-funnel="B2B" data-mode="B2B_ã‚¢ãƒŠãƒªã‚¹ãƒˆ" id="cta-b2b">
                <i class="fas fa-building"></i> äº‹æ¥­è€…å‘ã‘ï¼šãƒªã‚¹ã‚¯è¨ºæ–­ã‚’é–‹å§‹
              </button>
              <button class="btn btn-secondary specialist-btn" data-funnel="B2C" data-mode="ã‚´ãƒ¼ãƒ«ãƒ‰" id="cta-b2c">
                <i class="fas fa-home"></i> å€‹äººå‘ã‘ï¼šå®‰å¿ƒè¨ºæ–­ã‚’é–‹å§‹
              </button>
            </div>

            <div class="urgency-bar">
              æœ¬æ—¥ã®ç„¡æ–™è¨ºæ–­å—ä»˜ æ®‹ã‚Šï¼š <span class="highlight" id="remaining-count"><?= usageStatsData.remainingToday ?></span> å
            </div>

          </div>
        </div>
      </section>

      <section class="why-ai section" id="why-ai">
        <div class="container">
          <h2 class="section-title">ã‚»ã‚«ãƒ³ãƒ‰ã‚ªãƒ”ãƒ‹ã‚ªãƒ³ã®é‡è¦æ€§</h2>
          <p class="section-subtitle">å»ºè¨­æ¥­ç•Œã®éš ã‚ŒãŸå•é¡Œã‚’ã€æœ€æ–°AIæŠ€è¡“ã§è§£æ±ºã—ã¾ã™ã€‚<br>
          ä»Šæœˆã€<span style="font-weight: bold; color: var(--color-secondary-red);" id="monthly-users-count"><?= usageStatsData.monthlyUsers ?></span>åãŒã“ã®è¨ºæ–­ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚
          </p>
          <div class="features-grid">
            <div class="feature-card">
              <div class="feature-icon">ğŸ”</div>
              <h3>ä¸é€æ˜ãªã‚³ã‚¹ãƒˆæ§‹é€ ã®<br>å¯è¦–åŒ–</h3>
              <p>è¦‹ç©æ›¸ã®å„é …ç›®ã‚’è©³ç´°åˆ†æã—ã€é©æ­£ä¾¡æ ¼ã¨ã®æ¯”è¼ƒã‚„ä¸æ˜ç­ãªè²»ç”¨ã‚’ç‰¹å®šã—ã¾ã™ã€‚ãƒãƒ£ãƒƒãƒˆã§ç–‘å•ç‚¹ã‚’æ·±æ˜ã‚Šã§ãã¾ã™ã€‚</p>
            </div>
            <div class="feature-card">
              <div class="feature-icon">ğŸ›¡ï¸</div>
              <h3>è¦‹ãˆãªã„ãƒªã‚¹ã‚¯ã®å¯è¦–<br>åŒ–</h3>
              <p>æ§‹é€ è¨ˆç®—æ›¸ã‚„å›³é¢ã‹ã‚‰æ½œåœ¨çš„ãªå®‰å…¨æ€§ãƒªã‚¹ã‚¯ã‚’ç™ºè¦‹ã€‚å°†æ¥çš„ãªãƒˆãƒ©ãƒ–ãƒ«ã‚’æœªç„¶ã«é˜²ããŸã‚ã®ææ¡ˆã‚’è¡Œã„ã¾ã™ã€‚</p>
            </div>
            <div class="feature-card">
              <div class="feature-icon">âš¡</div>
              <h3>å³åº§ã«å°‚é–€çŸ¥è­˜ã‚’<br>æ´»ç”¨</h3>
              <p>é€šå¸¸ãªã‚‰è¤‡æ•°ã®å°‚é–€å®¶ã«ç›¸è«‡ãŒå¿…è¦ãªå†…å®¹ã‚’ã€AIãŒå³åº§ã«ç·åˆåˆ¤æ–­ã€‚æ™‚é–“ã¨è²»ç”¨ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚</p>
            </div>
          </div>
        </div>
      </section>

      <section class="expert-section section" id="expert-profile">
        <div class="container">
          <h2 class="section-title">ç›£ä¿®ãƒ»é‹å–¶è²¬ä»»è€…</h2>
          <div class="expert-profile">
            <div class="expert-image">
              <img src="https://via.placeholder.com/200?text=Profile+Photo" alt="ä»£è¡¨å–ç· å½¹ ã€‡ã€‡ ã€‡ã€‡ã®å†™çœŸ" loading="lazy">
            </div>
            <div class="expert-bio">
              <h3>ä»£è¡¨å–ç· å½¹ ã€‡ã€‡ ã€‡ã€‡</h3>
              <p class="expert-title">æ ªå¼ä¼šç¤¾ç›¸æ¨¡å»ºè¨­ãƒ„ã‚¯ãƒ«ãƒ³ã‚¸ãƒ£ãƒ¼</p>
              <p>
                å»ºè¨­æ¥­ç•Œã§ã®17å¹´ä»¥ä¸Šã®çµŒé¨“ã«åŸºã¥ãã€ãŠå®¢æ§˜ãŒç›´é¢ã™ã‚‹ä¸å®‰ã‚„ç–‘å•ã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ã€ã“ã®AIè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹ç™ºã—ã¾ã—ãŸã€‚ç§ãŸã¡ã¯ã€é€æ˜æ€§ã®é«˜ã„æƒ…å ±æä¾›ã¨ã€ãŠå®¢æ§˜ã®è³‡ç”£ã‚’å®ˆã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«è€ƒãˆã¦ã„ã¾ã™ã€‚AIã«ã‚ˆã‚‹å®¢è¦³çš„ãªåˆ†æã¨ã€æˆ‘ã€…ã®å°‚é–€çŸ¥è­˜ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€çš†æ§˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æˆåŠŸã«å°ãã¾ã™ã€‚
              </p>
              <p class="expert-credentials">
                ä¿æœ‰è³‡æ ¼ï¼šä¸€ç´šåœŸæœ¨æ–½å·¥ç®¡ç†å£«<br>
                å»ºè¨­æ¥­è¨±å¯ï¼šç¥å¥ˆå·çœŒçŸ¥äº‹è¨±å¯ï¼ˆèˆ¬-Xï¼‰ç¬¬XXXXXå·
              </p>
            </div>
          </div>
        </div>
      </section>

      <section class="works-section section" id="works">
        <div class="container">
          <h2 class="section-title">ä¿¡é ¼ã®è¨¼ï¼šæœ€æ–°ã®æ–½å·¥äº‹ä¾‹</h2>
          <? if (caseStudiesError) { ?>
          <div class="admin-warning">
            <strong>ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å‘ã‘è­¦å‘Šã€‘</strong> æ–½å·¥äº‹ä¾‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small><?= caseStudiesError ?></small>
          </div>
          <? } ?>
          <div class="blog-list">
          <? safeCaseStudies.slice(0, 3).forEach(article => { ?>
          <a href="<?= baseUrl ?>?page=case_<?= article.id ?>" class="blog-card">
          <? if (article.thumbnailUrl) { ?>
            <img src="<?= article.thumbnailUrl ?>" alt="<?= article.title ?>ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ" class="blog-card-image" loading="lazy">
          <? } else { ?>
            <div class="blog-card-image-placeholder"><i class="fas fa-hard-hat"></i></div>
          <? } ?>
          <div class="blog-card-content">
          <p class="blog-card-meta"><?= article.date ?> | <?= article.region ?></p>
          <h3><?= article.title ?></h3>
          <p><?= article.description ?></p>
          </div>
          </a>
          <? }); ?>
          </div>
          <? if (safeCaseStudies.length > 0) { ?>
          <div class="blog-list-link">
            <a href="<?= baseUrl ?>?page=list" class="btn btn-secondary">å…¨ã¦ã®æ–½å·¥äº‹ä¾‹ã‚’è¦‹ã‚‹</a>
          </div>
          <? } else if (!caseStudiesError) { ?>
            <p style="text-align: center; margin-top: 50px;">æœ€æ–°ã®æ–½å·¥äº‹ä¾‹ã‚’æº–å‚™ä¸­ã§ã™ã€‚</p>
          <? } ?>
        </div>
      </section>

      <? if (safeSeoPages.length > 0) { ?>
      <section class="section" style="background: var(--color-surface);">
        <div class="container">
          <h3 class="section-title">åœ°åŸŸåˆ¥ã‚µãƒ¼ãƒ“ã‚¹æ¡ˆå†…</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;">
          <? safeSeoPages.forEach(page => { ?>
            <a href="<?= baseUrl ?>?page=seo_<?= page.id ?>" class="btn-text" style="padding: 5px 10px;"><?= page.targetKeyword ?></a>
          <? }); ?>
          </div>
        </div>
      </section>
      <? } ?>

    <? } ?>

  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4><?= businessInfo.name ?></h4>
          <p>ã€’<?= businessInfo.address.postalCode ?> <?= businessInfo.address.addressRegion ?><?= businessInfo.address.addressLocality ?><?= businessInfo.address.streetAddress ?></p>
          <p>TEL: <?= businessInfo.telephone ?></p>

          <div class="social-links" style="margin-top: 20px;">
            <a href="https://www.instagram.com/kensetusentai/" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://www.tiktok.com/@tsukurunja" target="_blank" rel="noopener noreferrer" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
            <a href="https://line.me/ti/p/~kensetusentai88612" target="_blank" rel="noopener noreferrer" aria-label="LINE"><i class="fab fa-line"></i></a>
          </div>
        </div>
        <div class="footer-section">
          <h4>ã‚µã‚¤ãƒˆãƒãƒƒãƒ—</h4>
          <ul class="footer-links">
            <li><a href="<?= baseUrl ?>">HOME</a></li>
            <li><a href="<?= baseUrl ?>#why-ai">é¸ã°ã‚Œã‚‹ç†ç”±</a></li>
            <li><a href="<?= baseUrl ?>?page=list">æ–½å·¥äº‹ä¾‹</a></li>
            <li><a href="#expert-profile">å°‚é–€å®¶ç´¹ä»‹</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>é–¢é€£æƒ…å ±</h4>
          <ul class="footer-links">
            <li><a href="#">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
            <li><a href="<?= baseUrl ?>?page=sitemap.xml" target="_blank">XMLã‚µã‚¤ãƒˆãƒãƒƒãƒ—</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; <?= new Date().getFullYear() ?> <?= businessInfo.name ?>. All Rights Reserved.</p>
        <p id="systemVersionDisplay" style="font-size: 0.8em; color: #666; margin-top: 10px;">System Loading...</p>
      </div>
    </div>
  </footer>

  <div id="floating-cta">
    <a href="#hero-cta-anchor" class="btn btn-primary" aria-label="ç„¡æ–™è¨ºæ–­ã‚’é–‹å§‹">
      <i class="fas fa-comments-dollar"></i>
    </a>
  </div>

  <div id="aiChatDialog" class="ai-dialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h3 id="dialogTitle">AIãƒãƒ£ãƒƒãƒˆè¨ºæ–­</h3>
        <button class="close-dialog" data-target="aiChatDialog">&times;</button>
      </div>
      <div class="dialog-body">

        <div id="stage-initial" class="chat-stage">
          <div id="feedback-initial" class="positive-feedback"></div>

          <div class="form-group">
            <div id="dialogGreeting" class="message message-ai" style="max-width: 100%;"></div>
          </div>

          <div class="form-group">
            <label>è³‡æ–™ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒãƒ»PDFãƒ»Excelå¯¾å¿œï¼‰*</label>
            <div id="fileInputWrapper" class="file-input-wrapper">
              ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </div>
            <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.xlsx,.xls,.doc,.docx">
            <div id="fileStatus" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
          </div>

          <div class="form-group">
            <label for="initialMessage">ç›¸è«‡å†…å®¹ã‚„ã”è³ªå•ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="initialMessage" placeholder="ä¾‹ï¼šã“ã®è¦‹ç©ã‚‚ã‚Šã®ä»®è¨­å·¥äº‹è²»ã¯å¦¥å½“ã§ã—ã‚‡ã†ã‹ï¼Ÿ"></textarea>
          </div>

          <button id="startSocratesBtn" class="btn btn-primary" style="width: 100%;">
            æ¬¡ã¸ï¼šè¨ºæ–­æ–¹é‡ã®é¸æŠ
          </button>

          <div id="initialErrorArea" class="status-message error" style="display: none;"></div>
        </div>

        <div id="stage-socrates" class="chat-stage">
          <div id="feedback-socrates" class="positive-feedback"></div>

          <h3>ã“ã®è¨ºæ–­ã§ã€ã‚ãªãŸãŒæœ€ã‚‚çŸ¥ã‚ŠãŸã„ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ</h3>
          <p>é¸æŠã•ã‚ŒãŸæ–¹é‡ã«åŸºã¥ãã€AIãŒæœ€é©ãªåˆ†æã‚’è¡Œã„ã¾ã™ã€‚</p>

          <div class="socrates-options">
            <button class="socrates-btn" data-level="L1">
              <h4>ãƒ¬ãƒ™ãƒ«1ï¼šå…¨ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒæ¬²ã—ã„</h4>
              <p>ï¼ˆå…±æ„Ÿçš„ãƒ»ç¤ºå”†çš„ï¼‰ã¾ãšã¯å…¨ä½“åƒã‚’æŠŠæ¡ã—ã€å°‚é–€å®¶ã«ç›¸è«‡ã™ã¹ãã‹åˆ¤æ–­ã—ãŸã„ã€‚</p>
            </button>
            <button class="socrates-btn" data-level="L2">
              <h4>ãƒ¬ãƒ™ãƒ«2ï¼šä»–ç¤¾ã¨ã®æ¯”è¼ƒãƒã‚¤ãƒ³ãƒˆãŒçŸ¥ã‚ŠãŸã„</h4>
              <p>ï¼ˆå®¢è¦³çš„ãƒ»æŒ‡æ‘˜çš„ï¼‰æ¥­ç•Œæ¨™æº–ã‚„çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€å®¢è¦³çš„ãªæ¯”è¼ƒæ¤œè¨ã‚’è¡Œã„ãŸã„ã€‚</p>
            </button>
            <button class="socrates-btn" data-level="L3">
              <h4>ãƒ¬ãƒ™ãƒ«3ï¼šéš ã‚ŒãŸãƒªã‚¹ã‚¯ã‚’å¾¹åº•çš„ã«çŸ¥ã‚ŠãŸã„</h4>
              <p>ï¼ˆå³æ ¼ãƒ»æ–­å®šçš„ï¼‰è³‡æ–™ã«æ½œã‚€æ¬ é™¥ã‚„ãƒªã‚¹ã‚¯ã‚’æ´—ã„å‡ºã—ã€å¥‘ç´„ã®å¦¥å½“æ€§ã‚’å³ã—ãåˆ¤æ–­ã—ãŸã„ã€‚</p>
            </button>
          </div>
        </div>

        <div id="stage-chat" class="chat-stage">
          <div id="chatMessages" class="chat-messages">
            </div>

          <div id="chatInputArea" class="chat-input-area">
            <input type="text" id="chatInput" placeholder="è¿½åŠ ã®è³ªå•ã‚’å…¥åŠ›...">
            <button id="sendBtn" class="send-btn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>

          <div class="chat-footer">
            <button id="finishChatBtn" class="btn btn-secondary">
              ãƒãƒ£ãƒƒãƒˆã‚’çµ‚äº†ã—ã€å°‚é–€å®¶ã¸ç›¸è«‡
            </button>
          </div>
        </div>

        <div id="stage-inquiry" class="chat-stage">
          <form id="inquiryForm">
            <div class="form-group" style="display: none;">
              <textarea id="aiSummaryField" readonly></textarea>
            </div>
            <div class="form-group" style="display: none;">
              <input type="text" id="fileInfo" readonly>
            </div>

            <p style="text-align: center; margin-bottom: 30px;">AIãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã«åŸºã¥ãã€å°‚é–€å®¶ãŒè©³ç´°ãªã”ç›¸è«‡ã‚’æ‰¿ã‚Šã¾ã™ã€‚<br>ã”é€£çµ¡å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

            <div class="form-group">
              <label for="customerName">ãŠåå‰ *</label>
              <input type="text" id="customerName" required>
            </div>
            <div class="form-group">
              <label for="customerEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
              <input type="email" id="customerEmail" required>
            </div>
            <div class="form-group">
              <label for="customerPhone">é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
              <input type="tel" id="customerPhone">
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%;">ç›¸è«‡å†…å®¹ã‚’é€ä¿¡</button>
          </form>

          <div id="submitStatus" class="status-message" style="display: none;"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="exit-intent-popup">
    <div class="popup-content">
      <button class="popup-close">&times;</button>
      <h2>å°‘ã—ã ã‘ãŠæ™‚é–“ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ</h2>
      <p>ç–‘å•ã‚„ä¸å®‰ã‚’æŠ±ãˆãŸã¾ã¾ã€æ±ºæ–­ã‚’æ€¥ã„ã§ã„ã¾ã›ã‚“ã‹ï¼Ÿ</p>
      <p>AIã«ã‚ˆã‚‹ç„¡æ–™è¨ºæ–­ã¯ã€å®¢è¦³çš„ãªè¦–ç‚¹ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å¦¥å½“æ€§ã‚’ç¢ºèªã™ã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚Šã¾ã™ã€‚<br>å®‰å¿ƒã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚ã«ã€ãœã²ã”æ´»ç”¨ãã ã•ã„ã€‚</p>
      <button id="popup-start-diagnosis" class="btn btn-primary" style="margin-top: 20px;">
        ä»Šã™ãç„¡æ–™è¨ºæ–­ã‚’è©¦ã™
      </button>
    </div>
  </div>

<script>
/**
 * @fileoverview
 * ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰JavaScript (PHOENIX v5.1)
 */

document.addEventListener('DOMContentLoaded', function() {
  // --- å®šæ•°ã¨å¤‰æ•°ã®åˆæœŸåŒ– ---
  // ã€v5.1ã€‘ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
  const EXPECTED_VERSION = 'PHOENIX_v5.1_ABSOLUTE_OPTIMIZATION_FIXED';
  const MAX_FILE_SIZE = 7 * 1024 * 1024; // 7MB

  // DOMè¦ç´ ã®å–å¾—
  const chatDialog = document.getElementById('aiChatDialog');
  const fileInput = document.getElementById('fileInput');
  const initialMessageInput = document.getElementById('initialMessage');
  const chatMessagesArea = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');


  // çŠ¶æ…‹ç®¡ç†å¤‰æ•° (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
  let specialistAIs = {};
  let serverDiagnosticInfo = {};
  let currentMode = null;
  let currentAiPersona = null;
  let uploadedFile = null;
  let isProcessing = false;
  let chatHistory = [];
  let currentFunnelType = null;
  let currentResponseLevel = null;
  let sessionStartTime = null;

  // --- åˆæœŸåŒ–å‡¦ç† ---
  initialize();
  setupEventListeners();
  setupFloatingCta();
  setupExitIntentPopup();


  /**
   * æ–‡å­—åˆ—æ­£è¦åŒ–é–¢æ•° (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function normalizeString(str) {
    if (typeof str !== 'string') return '';
    let normalized = str.replace(/[\u200B-\u200D\uFEFF\u0000-\u001F\u007F-\u009F]/g, '').trim();
    normalized = normalized.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    const hankaku = "ï½±ï½²ï½³ï½´ï½µï½¶ï½·ï½¸ï½¹ï½ºï½»ï½¼ï½½ï½¾ï½¿ï¾€ï¾ï¾‚ï¾ƒï¾„ï¾…ï¾†ï¾‡ï¾ˆï¾‰ï¾Šï¾‹ï¾Œï¾ï¾ï¾ï¾ï¾‘ï¾’ï¾“ï¾”ï¾•ï¾–ï¾—ï¾˜ï¾™ï¾šï¾›ï¾œï½¦ï¾ï¾ï¾Ÿ";
    const zenkaku = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³ãƒ´ã‚œ";
    for (let i = 0; i < hankaku.length; i++) {
      normalized = normalized.replace(new RegExp(hankaku[i], 'g'), zenkaku[i]);
    }
    return normalized;
  }


  /**
   * GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒã‚§ãƒƒã‚¯ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function initialize() {
    // ã‚µãƒ¼ãƒãƒ¼è¨ºæ–­æƒ…å ±ã®å–å¾—ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    try {
      const rawDiagnosticInfo = document.body.dataset.diagnosticInfo;
      if (rawDiagnosticInfo) { serverDiagnosticInfo = JSON.parse(rawDiagnosticInfo); }
    } catch (e) { console.error("è¨ºæ–­æƒ…å ±ã®è§£æå¤±æ•—:", e); }

    const versionDisplay = document.getElementById('systemVersionDisplay');
    if (versionDisplay && serverDiagnosticInfo.version) {
      const apiMode = serverDiagnosticInfo.apiMode || 'N/A';
      versionDisplay.textContent = `System Version: ${serverDiagnosticInfo.version} | Mode: ${apiMode}`;
    }

    if (!serverDiagnosticInfo.version || serverDiagnosticInfo.version !== EXPECTED_VERSION) {
      const detectedVersion = serverDiagnosticInfo.version || 'ä¸æ˜';
      // alert('ã€è­¦å‘Šï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã®å¯èƒ½æ€§ã€‘\næœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³(' + EXPECTED_VERSION + ')ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nç¾åœ¨å®Ÿè¡Œä¸­ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ' + detectedVersion + '\n\nã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒªãƒ­ãƒ¼ãƒ‰(Ctrl+F5 / Cmd+Shift+R)ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
      console.warn(`Version mismatch. Expected: ${EXPECTED_VERSION}, Detected: ${detectedVersion}`);
    }

    // AIè¨­å®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
      const rawAiPrompts = document.body.dataset.aiPrompts;
      if (rawAiPrompts && rawAiPrompts.trim().startsWith('{')) {
        specialistAIs = JSON.parse(rawAiPrompts);
      }
    } catch (e) {
      console.error("AIè¨­å®šãƒ‡ãƒ¼ã‚¿ã®è§£æå¤±æ•—:", e);
    }
  }

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function setupEventListeners() {
    // AIè¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼‰
    document.querySelectorAll('.specialist-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const mode = btn.dataset.mode;
        const funnel = btn.dataset.funnel;
        openChatDialog(mode, funnel);

        // ã€T301: Argusã€‘GTMã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
        if (window.dataLayer) {
          window.dataLayer.push({
            'event': 'start_diagnosis_click',
            'funnel_type': funnel,
            'ai_mode': mode
          });
        }
      });
    });

    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    document.querySelectorAll('.close-dialog').forEach(btn => {
      btn.addEventListener('click', () => {
        chatDialog.classList.remove('active');
      });
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠUI
    const fileInputWrapper = document.getElementById('fileInputWrapper');
    if (fileInputWrapper && fileInput) {
      fileInputWrapper.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileUpload);
    }

    // ã€T401: SOCRATESã€‘è¨ºæ–­æ–¹é‡é¸æŠã¸é€²ã‚€ãƒœã‚¿ãƒ³
    const startSocratesBtn = document.getElementById('startSocratesBtn');
    if (startSocratesBtn) {
      startSocratesBtn.addEventListener('click', proceedToSocrates);
    }

    // ã€T401: SOCRATESã€‘è¨ºæ–­æ–¹é‡é¸æŠãƒœã‚¿ãƒ³
    document.querySelectorAll('.socrates-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const level = btn.dataset.level;
        startChatSession(level);
      });
    });


    // ãƒãƒ£ãƒƒãƒˆé€ä¿¡é–¢é€£
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
      sendBtn.addEventListener('click', () => sendChatMessage());
    }
    if (chatInput) {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatMessage();
        }
      });
    }

    // ãƒãƒ£ãƒƒãƒˆçµ‚äº†ãƒœã‚¿ãƒ³
    const finishChatBtn = document.getElementById('finishChatBtn');
    if (finishChatBtn) {
      finishChatBtn.addEventListener('click', finishChatSession);
    }

    // å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    const inquiryForm = document.getElementById('inquiryForm');
    if (inquiryForm) {
      inquiryForm.addEventListener('submit', submitInquiry);
    }
  }


  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) ---
  async function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      if (!file) return reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"));
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = () => reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"));
      reader.readAsDataURL(file);
    });
  }

  const showStatusMessage = (element, message, type = 'error') => {
    element.textContent = message;
    element.style.display = 'block';
    element.className = `status-message ${type}`;
  };


  // --- ãƒãƒ£ãƒƒãƒˆUIé–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ ---

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆç”»é¢ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function switchStage(stageId) {
    document.querySelectorAll('.chat-stage').forEach(stage => {
      stage.classList.remove('active');
    });
    const activeStage = document.getElementById(stageId);
    if (activeStage) {
        activeStage.classList.add('active');
    }
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.positive-feedback').forEach(el => el.style.display = 'none');
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
   */
  function openChatDialog(mode, funnel) {
    // çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
    fileInput.value = '';
    document.getElementById('fileStatus').textContent = '';
    initialMessageInput.value = '';
    chatMessagesArea.innerHTML = '';
    isProcessing = false;
    chatHistory = [];
    uploadedFile = null;
    currentFunnelType = funnel;
    currentResponseLevel = null;
    sessionStartTime = new Date(); // ã€T302ã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²

    // ãƒ¢ãƒ¼ãƒ‰åã‚’æ­£è¦åŒ–ã—ã¦æ¤œç´¢
    const normalizedMode = normalizeString(mode);

    // â€»æ³¨æ„ï¼šæŒ¨æ‹¶æ–‡ã¯ãƒ¬ãƒ™ãƒ«1ï¼ˆ_L1ï¼‰ã¾ãŸã¯ãƒ¬ãƒ™ãƒ«æŒ‡å®šãªã—ã®ã‚‚ã®ã‚’æ¢ã™
    let persona = specialistAIs[`${normalizedMode}_L1`] || specialistAIs[normalizedMode];

    // ã€v5.1 FIXã€‘B2Bãƒ¢ãƒ¼ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
    if (!persona) {
      let errorMessage = `ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘AIãƒ¢ãƒ¼ãƒ‰ã€Œ${mode}ã€ã®åŸºæœ¬è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n`;
      errorMessage += `ã‚·ãƒ¼ãƒˆã®Aåˆ—ã«ã€Œ${normalizedMode}_L1ã€ã¾ãŸã¯ã€Œ${normalizedMode}ã€ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n`;
      if (mode === 'B2B_ã‚¢ãƒŠãƒªã‚¹ãƒˆ') {
        errorMessage += `ç‰¹ã«äº‹æ¥­è€…å‘ã‘(B2B)ãƒ¢ãƒ¼ãƒ‰ã¯ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨­å®šãŒå¿…é ˆã§ã™ã€‚`;
      }
      alert(errorMessage);
      return;
    }

    currentMode = normalizedMode;
    currentAiPersona = persona;

    document.getElementById('dialogTitle').textContent = `${persona.name} ã¨ã®ãƒãƒ£ãƒƒãƒˆ (${funnel})`;
    document.getElementById('dialogGreeting').textContent = persona.greeting;

    switchStage('stage-initial');
    chatDialog.classList.add('active');
  }

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function handleFileUpload() {
    const file = fileInput.files[0];
    if (!file) return;

    const errorArea = document.getElementById('initialErrorArea');
    errorArea.style.display = 'none';

    if (file.size > MAX_FILE_SIZE) {
      showStatusMessage(errorArea, `ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§${(MAX_FILE_SIZE / (1024 * 1024)).toFixed(0)}MBï¼‰ã€‚`);
      uploadedFile = null;
      return;
    }

    uploadedFile = file;
    document.getElementById('fileStatus').textContent = `é¸æŠæ¸ˆã¿: ${file.name}`;
  }

  /**
   * ã€T401: SOCRATESã€‘è¨ºæ–­æ–¹é‡é¸æŠã¸é€²ã‚€ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function proceedToSocrates() {
    const errorArea = document.getElementById('initialErrorArea');
    errorArea.style.display = 'none';

    if (!uploadedFile) {
      showStatusMessage(errorArea, 'è³‡æ–™ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // ã€T205: Cialdini-Primeã€‘ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    switchStage('stage-socrates');
    const feedback = document.getElementById('feedback-socrates');
    feedback.textContent = 'ç´ æ™´ã‚‰ã—ã„ï¼è³‡æ–™ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
    feedback.style.display = 'block';
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  async function startChatSession(level) {
    currentResponseLevel = level;

    // ã€T301: Argusã€‘GTMã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
    if (window.dataLayer) {
        window.dataLayer.push({
            'event': 'select_diagnosis_level',
            'funnel_type': currentFunnelType,
            'response_level': level
        });
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆ
    switchStage('stage-chat');

    // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    const initialMessage = initialMessageInput.value.trim() || 'æ·»ä»˜è³‡æ–™ã‚’ç¢ºèªã—ã€è¨ºæ–­ã—ã¦ãã ã•ã„ã€‚';
    await sendChatMessage(initialMessage, true);
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¿½åŠ ã™ã‚‹ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function addMessageToChat(role, text) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    if (role === 'user') {
      messageElement.classList.add('message-user');
    } else if (role === 'model') {
      messageElement.classList.add('message-ai');
    } else {
      messageElement.classList.add('message-system');
    }

    messageElement.textContent = text;
    chatMessagesArea.appendChild(messageElement);
    chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
  }

  /**
   * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®è¡¨ç¤º/éè¡¨ç¤º (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function toggleLoading(show) {
    let loadingElement = document.getElementById('loadingIndicator');
    if (show) {
      if (!loadingElement) {
        loadingElement = document.createElement('div');
        loadingElement.id = 'loadingIndicator';
        loadingElement.classList.add('loading-indicator');
        loadingElement.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        chatMessagesArea.appendChild(loadingElement);
      }
      chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
    } else {
      if (loadingElement) {
        loadingElement.remove();
      }
    }
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ– (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function setInputState(enabled) {
    isProcessing = !enabled;
    chatInput.disabled = !enabled;
    document.getElementById('sendBtn').disabled = !enabled;
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã€AIã®å¿œç­”ã‚’å–å¾—ã™ã‚‹ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  async function sendChatMessage(messageText = null, isFirstTurn = false) {
    if (isProcessing) return;

    const message = messageText || chatInput.value.trim();
    if (!message) return;

    addMessageToChat('user', message);
    chatHistory.push({ role: 'user', text: message });

    chatInput.value = '';
    setInputState(false);
    toggleLoading(true);

    try {
      const requestData = {
        mode: currentMode,
        // ã€T403: SOCRATESã€‘å¿œç­”ãƒ¬ãƒ™ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
        responseLevel: currentResponseLevel,
        message: message,
        history: chatHistory.slice(0, -1),
        fileData: null,
        fileName: null,
        fileMimeType: null
      };

      // åˆå›ã‚¿ãƒ¼ãƒ³ã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ãƒ»æ·»ä»˜
      if (isFirstTurn && uploadedFile) {
        try {
          const dataUrl = await readFileAsDataURL(uploadedFile);
          requestData.fileData = dataUrl;
          requestData.fileName = uploadedFile.name;
          requestData.fileMimeType = uploadedFile.type || 'application/octet-stream';
        } catch (fileError) {
          throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + fileError.message);
        }
      }

      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        throw new Error("Google Apps Scripté€£æºæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
      }

      const payload = JSON.stringify(requestData);

      google.script.run
        .withSuccessHandler((response) => {
          toggleLoading(false);
          setInputState(true);

          if (response.status === 'success') {
            addMessageToChat('model', response.responseMessage);
            chatHistory.push({ role: 'model', text: response.responseMessage });
          } else {
            addMessageToChat('system', 'ã‚¨ãƒ©ãƒ¼: ' + response.message);
          }
          chatInput.focus();
        })
        .withFailureHandler((error) => {
          toggleLoading(false);
          setInputState(true);
          addMessageToChat('system', 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .processChatMessage(payload);

    } catch (error) {
      toggleLoading(false);
      setInputState(true);
      addMessageToChat('system', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
  }

  /**
   * ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã€å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã¸ç§»è¡Œã™ã‚‹ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function finishChatSession() {
    // ä¼šè©±å±¥æ­´ã‚’æ•´å½¢ã—ã¦å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã«è»¢è¨˜
    let summary = '';
    if (currentAiPersona) {
      summary += `ã€${currentAiPersona.name}ã¨ã®ãƒãƒ£ãƒƒãƒˆè¨ºæ–­å±¥æ­´ã€‘\n\n`;
    }

    chatHistory.forEach(item => {
      const speaker = item.role === 'user' ? 'é¡§å®¢' : 'AI';
      summary += `[${speaker}]\n${item.text}\n\n`;
    });

    document.getElementById('aiSummaryField').value = summary;
    document.getElementById('fileInfo').value = uploadedFile ? uploadedFile.name : 'ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ãªã—';

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('dialogTitle').textContent = 'å°‚é–€å®¶ã¸ã®ç›¸è«‡ãƒ•ã‚©ãƒ¼ãƒ ';
    switchStage('stage-inquiry');
  }


  // --- å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ é–¢é€£ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—) ---

  async function submitInquiry(e) {
    e.preventDefault();
    const submitStatus = document.getElementById('submitStatus');
    const submitBtn = document.getElementById('submitBtn');

    submitBtn.disabled = true;
    showStatusMessage(submitStatus, 'é€ä¿¡ä¸­...', 'success');

    // ã€T302: Hydraã€‘ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‰€è¦æ™‚é–“ã¨ãƒãƒ£ãƒƒãƒˆå¾€å¾©å›æ•°ã‚’è¨ˆç®—
    const sessionEndTime = new Date();
    const sessionDuration = sessionStartTime ? Math.round((sessionEndTime - sessionStartTime) / 1000) : 0;
    const chatTurns = Math.ceil(chatHistory.length / 2);

    const data = {
      name: document.getElementById('customerName').value,
      email: document.getElementById('customerEmail').value,
      phone: document.getElementById('customerPhone').value,
      aiSummary: document.getElementById('aiSummaryField').value,
      aiMode: currentMode || 'ä¸æ˜',
      // ã€T302: Hydraã€‘æ‹¡å¼µãƒ‡ãƒ¼ã‚¿
      funnelType: currentFunnelType,
      chatTurns: chatTurns,
      sessionDuration: sessionDuration,
      fileData: null,
      fileName: null,
      fileMimeType: null
    };

    // ã€T301: Argusã€‘GTMã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
    if (window.dataLayer) {
        window.dataLayer.push({
            'event': 'submit_inquiry',
            'funnel_type': currentFunnelType,
            'session_duration': sessionDuration,
            'chat_turns': chatTurns
        });
    }

    try {
      // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
      if (uploadedFile) {
        try {
          const dataUrl = await readFileAsDataURL(uploadedFile);
          data.fileData = dataUrl;
          data.fileName = uploadedFile.name;
          data.fileMimeType = uploadedFile.type;
        } catch (fileError) {
          console.warn("ãƒ•ã‚¡ã‚¤ãƒ«å†èª­ã¿è¾¼ã¿å¤±æ•—:", fileError);
        }
      }

      if (typeof google === 'undefined' || !google.script || !google.script.run) {
        throw new Error("Google Apps Scripté€£æºæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
      }

      const payload = JSON.stringify(data);

      google.script.run
        .withSuccessHandler((response) => {
          if (response.status === 'success') {
            showStatusMessage(submitStatus, response.message, 'success');
            document.getElementById('inquiryForm').reset();
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            uploadedFile = null;
            currentMode = null;
            chatHistory = [];

            setTimeout(() => {
              chatDialog.classList.remove('active');
              submitBtn.disabled = false;
            }, 3000);

          } else {
            showStatusMessage(submitStatus, response.message, 'error');
            submitBtn.disabled = false;
          }
        })
        .withFailureHandler((error) => {
          showStatusMessage(submitStatus, 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' + error.message, 'error');
          submitBtn.disabled = false;
        })
        .submitInquiry(payload);

    } catch (error) {
      showStatusMessage(submitStatus, 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      submitBtn.disabled = false;
    }
  }

  // --- PHOENIX v5.1 è¿½åŠ æ©Ÿèƒ½ ---

  /**
   * ã€T202: Fogg-Cascadeã€‘ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°CTAã®åˆ¶å¾¡ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function setupFloatingCta() {
    const floatingCta = document.getElementById('floating-cta');
    const heroSection = document.querySelector('.hero');
    // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ä»¥å¤–ã§ã¯å¸¸ã«è¡¨ç¤º
    if (window.location.search.includes('page=')) {
        if (floatingCta) floatingCta.classList.add('visible');
        return;
    }

    if (!floatingCta || !heroSection) return;

    window.addEventListener('scroll', () => {
      // ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é«˜ã•ã‚’è¶…ãˆãŸã‚‰è¡¨ç¤º
      if (window.scrollY > heroSection.offsetHeight) {
        floatingCta.classList.add('visible');
      } else {
        floatingCta.classList.remove('visible');
      }
    });
  }

  /**
   * ã€T209: LAST RESORTã€‘é›¢è„±é˜²æ­¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®åˆ¶å¾¡ (v5.0ã‹ã‚‰å¤‰æ›´ãªã—)
   */
  function setupExitIntentPopup() {
    const popup = document.getElementById('exit-intent-popup');
    if (!popup) return;

    let shownOnce = false;

    const showPopup = (e) => {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã‹ã‚‰é›¢ã‚Œã‚ˆã†ã¨ã—ãŸæ™‚ã€ã‹ã¤æœªè¡¨ç¤ºã€ã‹ã¤ãƒãƒ£ãƒƒãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒéè¡¨ç¤ºã®å ´åˆ
      if (e.clientY <= 0 && !shownOnce && !chatDialog.classList.contains('active')) {
        popup.style.display = 'flex';
        shownOnce = true;
      }
    };

    // ãƒã‚¦ã‚¹ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¤–ã«å‡ºãŸæ™‚ã‚’æ¤œçŸ¥
    document.addEventListener('mouseleave', showPopup);

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
    popup.querySelector('.popup-close').addEventListener('click', () => {
      popup.style.display = 'none';
    });

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰è¨ºæ–­é–‹å§‹
    document.getElementById('popup-start-diagnosis').addEventListener('click', () => {
      popup.style.display = 'none';
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦B2Cãƒ•ã‚¡ãƒãƒ«ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼‰ã§é–‹å§‹
      openChatDialog('ã‚´ãƒ¼ãƒ«ãƒ‰', 'B2C');
    });
  }

});
</script>
</body>
</html>