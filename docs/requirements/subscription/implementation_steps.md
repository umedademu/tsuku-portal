# 実装ステップ（画面変化が見える粒度で10ステップ）

## ステップ1：トップに「ログイン」「新規登録」ボタンを追加
- ヒーローエリアに並べて配置し、視認性の高いボタンスタイルで実装する。
- この段階ではクリックしても処理は実行せず、押下できるUIだけを用意する。
- レイアウト崩れがないことと、ボタンのホバー・フォーカス状態が分かることを確認する。

## ステップ2：`/auth/login` `/auth/signup` へのフォーム枠を用意
- ボタン押下で各ページに遷移し、メールとパスワードの入力欄を持つフォームを表示する。
- 入力必須・最低文字数などの基本バリデーションを入れ、送信ボタンを配置する。
- この段階ではまだ認証処理は行わず、フォームUIと遷移のみ動作させる。

## ステップ3：Supabase Authに接続してトップへ戻す
- `.env.local` と Vercel に `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` を設定して認証クライアントを有効化する。
- サインアップ時は `emailRedirectTo=/auth/callback` を付けて確認メールを送信し、ログイン時は `signInWithPassword` を呼び出す。
- `/auth/callback` でハッシュの `access_token` / `refresh_token` を `setSession` し、`code` / `token` があれば `exchangeCodeForSession` でフォローする。
- セッション確立後はトップへ戻し、`auth` クエリ経由で「ログイン完了」「メール確認完了」などの通知を表示する。
- 確認メールの再利用や期限切れは `otp_expired` になるため、新しいメールで再度確認する運用とする。

## ステップ4：診断専用ページの骨組みを用意（完了）
- トップとは別のURL `/workspace` に、資料アップロード枠とチャット枠を1画面で見せるダミーページを作成した。
- 「無料診断を開始」のポップ内容を参考に、添付枠（8MB上限の見た目のみ）と簡易チャット（仮応答）を配置し、今後の本実装に差し替えられる骨組みを用意した。

## ステップ5：新規登録・ログイン後の遷移先を診断ページに変更（完了）
- 認証成功時の行き先をトップ`/`から診断ページ`/workspace`へ切り替えた。
- ログイン・新規登録・メール認証完了時はいずれも`/workspace?auth=...`で到達し、診断ページ側で通知を表示してからクエリを消すようにした。

## ステップ6：ログイン中表示とログアウト導線を追加（完了）
- `/workspace` ページの上部に「ログイン中のメールアドレス」と「ログアウト」ボタンを追加し、ログイン状態を明示するようにした。
- Supabase Auth のセッションを監視し、ログアウトを押すと `/` へ遷移するようにした。未ログインで直接アクセスした場合もサーバー側のmiddlewareで `/` へ303リダイレクトする。
- 未ログイン時の表示が一瞬でも見えないよう、サーバー側で先に判定して弾く設計に切り替えた。

## ステップ7：無料残数の表示・減算・残0時の誘導をダミー実装（完了）
- `/workspace` 上で無料残数（3回）を表示し、チャット送信のたびに1減るダミー挙動にした。ページ再読み込みで元に戻る。
- 残数0になると送信ボタンを無効化し、プラン選択ページ `/checkout/plan` への導線（ダミー文言）を表示する。
- いずれも画面内の仮実装であり、後続ステップでサーバー側の残数管理と連動させる。

## ステップ8：`/checkout/plan` のプランカード表示（完了）
- `/checkout/plan` にプラン選択ページを新設し、Blue / Green / Gold の3枚のカードを左から並べて表示した。
- カードには想定利用シーンや特徴の箇条書きを記載し、選択したプランをこのページ内で保持する（ブラウザを閉じるとリセット）。
- 決済開始ボタンは無効化したままにし、「決済や残数連動は次のステップで接続する」旨を明記した。
- 診断ページ `/workspace` への戻り導線を配置し、無料枠を使い切った後にここへ誘導する想定を示した。

## ステップ9：プラン選択後のStripe Checkout遷移（完了）
- `/checkout/plan` の「決済へ進む」から `/api/checkout/session` を呼び出し、選択プラン（blue/green/gold）のPrice IDで Stripe Checkout を起票するようにした。
- API側で Supabase のログイン状態を検証し、未ログインなら 401 で弾く。ブラウザのSupabaseクライアントを auth-helpers に切り替え、Cookie共有でサーバーがユーザーを取得できるようにした。
- Stripe の API バージョン指定は外し、成功/キャンセル後の戻り先 `/checkout/success` / `/checkout/cancel` を追加した（状態反映は次ステップ）。
- 環境変数は `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` / `STRIPE_SECRET_KEY` / `STRIPE_PRICE_BLUE` / `STRIPE_PRICE_GREEN` / `STRIPE_PRICE_GOLD` を利用する（Vercel側にも設定が必要）。

## ステップ10：決済成功後の状態反映（完了）
- Stripe Checkout から戻った `/checkout/success` でセッションIDを受け取り、`/api/checkout/confirm` に投げてStripe上の決済内容を検証するようにした。
- 検証結果を Supabase に保存するようにした（`checkout_sessions` / `user_profiles` / `usage_counts`）。プラン種別・サブスク状態・customer_id / subscription_id を記録する。
- 成功ページは動的レンダリングに切り替え、サーバーからセッションIDが取れない場合でもクエリから拾って反映するようにした。
- 画面ではプランとサブスク状態、次回更新目安、ID末尾などを表示し、診断ページへの導線を維持する。
- まだ未実装: Webhookによる継続課金・解約の自動反映、無料枠カウントとの連動（`usage_counts` は保存のみで未連動）。後続で対応する。

## 要件整理
- プランごとにプロンプトが異なる（blue / green / gold は `docs/prompts` および `prompts_json.txt` を参照）。
- 診断回答は「1ユーザーにつき生涯で最初の3回まで無料」とする。
- 4回目の回答リクエストが来たタイミングで、回答ボタンの代わりにプラン選択画面（`/checkout/plan`）へ誘導する。
- プラン未契約ユーザーはプラン選択画面で「blue / green / gold」のいずれかを選び、その結果を使って Stripe Checkout を開始する。
- 一度プラン契約が完了したユーザーは、以後は回答回数に制限をかけず、サブスクリプションの状態（有効／停止）だけで利用可否を判定する。
- ユーザーの識別は Supabase Auth のユーザーID（`user.id`）を使う。
  - 各ユーザーの回答回数をサーバー側のDBでカウントし、無料枠の残り回数を管理する。
- プロンプトは `PROMPTS_JSON` 環境変数（Vercelに設定済み）で管理し、元データは `docs/prompts/*.md` / `prompts_json.txt` を参照する。
- 環境変数は `.env.local` と Vercel に揃える（例: `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` など）。`.env.local` は `apps/web/.env.local` に配置。
