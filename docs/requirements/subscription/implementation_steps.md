# 実装ステップ（画面変化が見える粒度で12ステップ）

## ステップ1：トップに「ログイン」「新規登録」ボタンを追加
- ヒーローエリアに並べて配置し、視認性の高いボタンスタイルで実装する。
- この段階ではクリックしても処理は実行せず、押下できるUIだけを用意する。
- レイアウト崩れがないことと、ボタンのホバー・フォーカス状態が分かることを確認する。

## ステップ2：`/auth/login` `/auth/signup` へのフォーム枠を用意
- ボタン押下で各ページに遷移し、メールとパスワードの入力欄を持つフォームを表示する。
- 入力必須・最低文字数などの基本バリデーションを入れ、送信ボタンを配置する。
- この段階ではまだ認証処理は行わず、フォームUIと遷移のみ動作させる。

## ステップ3：Supabase Authに接続してトップへ戻す
- `.env.local` と Vercel に `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` を設定して認証クライアントを有効化する。
- サインアップ時は `emailRedirectTo=/auth/callback` を付けて確認メールを送信し、ログイン時は `signInWithPassword` を呼び出す。
- `/auth/callback` でハッシュの `access_token` / `refresh_token` を `setSession` し、`code` / `token` があれば `exchangeCodeForSession` でフォローする。
- セッション確立後はトップへ戻し、`auth` クエリ経由で「ログイン完了」「メール確認完了」などの通知を表示する。
- 確認メールの再利用や期限切れは `otp_expired` になるため、新しいメールで再度確認する運用とする。

## ステップ4：診断専用ページの骨組みを用意（未実装）
- トップとは別のURLで、診断に必要なUIの土台とダミー表示を用意する。

## ステップ5：新規登録・ログイン後の遷移先を診断ページに変更（未実装）
- 認証成功時のリダイレクト先をトップから診断ページへ切り替える。

## ステップ6：ログイン中表示とログアウト導線を追加（未実装）

## ステップ7：無料残り回数の表示（未実装）

## ステップ8：チャット送信と残り回数の減算（未実装）

## ステップ9：残り0回時のプラン選択誘導（未実装）

## ステップ10：`/checkout/plan` のプランカード表示（未実装）

## ステップ11：プラン選択後のStripe Checkout遷移（未実装）

## ステップ12：決済成功後の状態反映（未実装）

## 要件整理
- プランごとにプロンプトが異なる（blue / green / gold は `docs/prompts` および `prompts_json.txt` を参照）。
- 診断回答は「1ユーザーにつき生涯で最初の3回まで無料」とする。
- 4回目の回答リクエストが来たタイミングで、回答ボタンの代わりにプラン選択画面（`/checkout/plan`）へ誘導する。
- プラン未契約ユーザーはプラン選択画面で「blue / green / gold」のいずれかを選び、その結果を使って Stripe Checkout を開始する。
- 一度プラン契約が完了したユーザーは、以後は回答回数に制限をかけず、サブスクリプションの状態（有効／停止）だけで利用可否を判定する。
- ユーザーの識別は Supabase Auth のユーザーID（`user.id`）を使う。
  - 各ユーザーの回答回数をサーバー側のDBでカウントし、無料枠の残り回数を管理する。
- プロンプトは `PROMPTS_JSON` 環境変数（Vercelに設定済み）で管理し、元データは `docs/prompts/*.md` / `prompts_json.txt` を参照する。
- 環境変数は `.env.local` と Vercel に揃える（例: `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` など）。`.env.local` は `apps/web/.env.local` に配置。
