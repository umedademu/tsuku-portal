# 実装ステップ（画面変化が見える粒度で10ステップ）

1. トップに「ログイン」「新規登録」ボタンを追加（押下でまだ何もしない）。
2. ボタンから `/auth/login` `/auth/signup` へ遷移できるフォーム枠を用意（メール+パス入力欄）。
3. フォーム送信でSupabase Authに接続し、成功時にトップへ戻る（成功メッセージ確認）。
4. トップに「ログイン中：○○さん」「ログアウト」表示を追加し、ログアウトで表示が消えることを確認。
5. トップに無料残り回数を表示（例：「無料残り：あと3回」）。
6. チャット送信時に残り回数を減らし、表示が即時更新されるようにする（3→2→1→0）。
7. 残り0回になったら送信ボタンを「プランを選ぶ」ボタンに切り替え、送信不可を表示。
8. `/checkout/plan` にプランカード（blue/green/gold）と「決済へ進む」ボタンを配置。
9. プラン選択後、「決済へ進む」でStripe Checkout画面へ遷移できるようにする。
10. 決済成功後 `/checkout/success` で成功表示し、トップにも「プラン: gold（例）」などの有効状態を反映。

## 要件整理
- プランごとにプロンプトが異なる（blue / green / gold は `docs/prompts` および `prompts_json.txt` を参照）。
- 診断回答は「1ユーザーにつき生涯で最初の3回まで無料」とする。
- 4回目の回答リクエストが来たタイミングで、回答ボタンの代わりにプラン選択画面（`/checkout/plan`）へ誘導する。
- プラン未契約ユーザーはプラン選択画面で「blue / green / gold」のいずれかを選び、その結果を使って Stripe Checkout を開始する。
- 一度プラン契約が完了したユーザーは、以後は回答回数に制限をかけず、サブスクリプションの状態（有効／停止）だけで利用可否を判定する。
- ユーザーの識別は Supabase Auth のユーザーID（`user.id`）を使う。
  - 各ユーザーの回答回数をサーバー側のDBでカウントし、無料枠の残り回数を管理する。
- プロンプトは `PROMPTS_JSON` 環境変数（Vercelに設定済み）で管理し、元データは `docs/prompts/*.md` / `prompts_json.txt` を参照する。
- 環境変数は `.env.local` と Vercel に揃える（例: `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` など）。`.env.local` は `apps/web/.env.local` に配置。
