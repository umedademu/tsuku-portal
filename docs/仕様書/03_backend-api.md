# 03 バックエンドとAPIの考え方

## 1. 目的
- フロント画面から受け取った情報を安全に保存し、必要なデータを返す仕組みを用意する。
- 問い合わせ送信、コンテンツ取得、AI連携など各機能を支えるAPIを整える。
- 障害が発生した場合でも原因を追跡しやすくし、すぐにリカバリーできる状態にする。

## 2. 開発の前提
- Vercel上で動くサーバーレス関数を使用し、Node.js向けの標準的な構成を採用する。
- TypeScriptなどの利用言語、ORM、ログ監視ツールはチームで選定し、運用コストとのバランスをとる。
- 認証はAPIキーやJWTなどを使い、外部公開するAPIと内部利用のAPIを明確に分ける。

## 3. 主なエンドポイント案
| Path | Method | 内容 | 認証の目安 | 備考 |
| --- | --- | --- | --- | --- |
| `/api/health` | GET | 動作確認 | なし | 200/503を返す |
| `/api/content/articles` | GET | 記事一覧の取得 | あればAPIキー | ページングと検索に対応 |
| `/api/content/articles/[slug]` | GET | 記事詳細 | なし | 公開済みのみ |
| `/api/content/case-studies` | GET | 事例一覧 | あればAPIキー | 業種などで絞り込み |
| `/api/content/case-studies/[slug]` | GET | 事例詳細 | なし |  | 
| `/api/stats/usage` | GET | 利用統計 | APIキー必須 | 管理画面向け |
| `/api/contact` | POST | 問い合わせ送信 | レート制限 | 応答を早く返す |
| `/api/contact/upload-url` | POST | 添付ファイル用URL発行 | レート制限 | 署名付きURL想定 |
| `/api/assistant` | POST | AI補助の呼び出し | レート制限 + 認証 |  |
| `/api/newsletter/subscribe` | POST | ニュース配信登録 | Bot対策 | 必要に応じて |

## 4. 入出力のイメージ
- 問い合わせ送信APIでは、セッションID・目的・質問の回答・連絡先・添付情報・同意状況を受け取り、受付IDとステータスメッセージを返す。
- AI補助APIでは、セッションID・会話履歴・補足情報を受け取り、提案内容とサマリー、信頼度などを返す。
- 返却形式はJSONとし、成功時と失敗時で共通のフォーマット（`status`, `message`, `data`, `code` など）を定義する。

## 5. 認証とレート制限
- 認証ヘッダーの書式は統一し、公開APIと内部APIで鍵を分ける。
- 問い合わせAPIは短時間での連続送信を防ぐため、セッションやIP単位でレート制限を設ける。
- AI関連のAPIは追加の署名や内部チェックを導入し、不正利用を抑止する。

## 6. エラー時の方針
- 入力誤りは4xx、サーバー側の問題は5xxで返し、エラーコード・説明文・再試行の案内を含める。
- レート制限に引っかかった場合は待ち時間を示す。
- 外部サービスが原因の場合は503を返し、ログに詳細を残す。
- すべてのレスポンスに追跡用IDを含め、調査時に同じ記録を見つけやすくする。

## 7. ログと監視
- ログはJSON形式で記録し、時刻・レベル・リクエストID・処理時間などを含める。
- エラーはSentryなどの監視サービスにも送信し、個人情報はマスクする。
- 時間のかかる処理は数値化して記録し、ダッシュボードで把握できるようにする。

## 8. セキュリティ
- CORSは自社ドメインに限定し、プリフライトの設定も行う。
- 管理画面でCookieを使う場合はCSRF対策を入れる。
- 受け取ったデータはサーバー側で必ず検証し、ファイルアップロード時は危険な内容がないかを確認する。
- APIキーなど機密情報は環境変数やシークレット管理機能で保持し、Gitに含めない。

## 9. デプロイと変更管理
- プルリクエストでプレビュー環境を確認したうえで本番に反映するフローを整える。
- Breaking変更が想定されるAPIはバージョンを分けるか、互換レイヤーを用意する。
- データベースの変更はマイグレーションファイルで管理し、自動デプロイと連携させる。

## 10. テスト
- 単体テストでロジックを確認し、外部APIはモック化する。
- 統合テストで主要なフローを通し、想定外入力にも耐えるか確認する。
- 問い合わせAPIなど重要な処理は負荷テストを行い、目標応答時間を決める。
- 定期的にセキュリティ診断を行い、脆弱性を早期に修正する。

## 11. 今後の検討事項
- 管理画面向けAPIの構成（RESTかGraphQLかなど）の最適化。
- エッジ機能を活用したレスポンス高速化。
- AI呼び出しが増えた場合のキュー制御やキャッシュの導入。
