# 05 AI連携の考え方

## 1. 目的
- 問い合わせや診断フローで、利用者に役立つ補助メッセージをAIで提示する。
- 担当者向けにも、まとめ情報や次のアクション案を自動で用意する。
- AIが使えない状況でも、サービス提供が止まらないようにする。

## 2. 主な利用シーン
1. 診断結果の補助案内  
   入力内容をもとに課題整理や推奨アクションを提示する。
2. 内部通知のサマリー  
   Slackなどに送る通知に、要約や優先度のヒントを添える。
3. コンテンツ作成のヒント（将来）  
   SEO記事やCTA文言を整える際の草案を生成する。

## 3. 連携方法
- フロントエンドからサーバー側のAPIを呼び出し、そこからGeminiなどのAIサービスへリクエストを送る。
- APIキーなどの機密情報は環境変数で管理し、コードに埋め込まない。
- 返ってきた内容は必要な項目だけを保存し、個人情報は含めない。

## 4. プロンプトの管理
- 目的別にテンプレートを用意し、差し込み項目を分かりやすく整理する。
- サービスのトーンや回答形式をテンプレート内で明記する。
- 差し込む内容はサニタイズし、不要な情報が混ざらないようにする。

## 5. リクエスト設定
- 使用モデル、温度、最大トークン数などは環境設定で変更できるようにする。
- タイムアウトを設け、一定時間で結果が返らない場合はフォールバックへ切り替える。
- 一時的な失敗時は数回まで自動で再試行するが、無限には繰り返さない。

## 6. レスポンス処理
- 期待する形（例：要約、提案の配列、信頼度など）を決めておき、プロンプトでも指示する。
- 解析に失敗した場合は再試行し、それでもだめなら定型文で対応する。
- フロントへ返すデータは必要なフィールドだけに絞る。

## 7. フォールバック
- AIが利用できない場合に表示する定型文を目的ごとに準備しておく。
- 信頼度が低いときは慎重な文言に切り替え、担当者への相談を促す。
- センシティブな内容が含まれると判断したら、AIの結果を破棄して人の対応に切り替える。

## 8. コスト管理
- 呼び出し回数とトークン数を記録し、日次・月次で上限を設ける。
- 出力が長くなりすぎないよう、パラメータを調整する。
- 利用状況をダッシュボードなどで定期的に確認する。

## 9. セキュリティとプライバシー
- 個人情報はプロンプトに含めず、必要に応じてマスクする。
- 不適切な内容が含まれていないか、送信前に簡易チェックを行う。
- 保存するログには個人情報を入れず、どうしても必要な場合は暗号化を検討する。

## 10. ログと監査
- 呼び出しごとにリクエストID、テンプレート名、処理時間、結果などを記録する。
- 失敗したレスポンスはマスクしたうえで保存し、トラブル調査に使う。
- 定期的にレビューを実施し、テンプレートやパラメータの改善に活かす。

## 11. テスト
- テンプレートの差し込み処理やレスポンス整形を単体テストで確認する。
- モックのAIサービスを使い、API全体の流れを検証する。
- 実際の入力例を使って人が目視でチェックし、品質や安全性を評価する。

## 12. 今後の検討
- 複数のAIサービスを切り替えられるようにアダプター層を用意する。
- 会話履歴やナレッジを参考に回答を補強する仕組み（RAGなど）を試す。
- 担当者返信の草案作成や記事づくりの支援など、周辺業務への展開を検討する。
