# 04 データの整理方針

## 1. 使う仕組み
- 文章や問い合わせなどの構造化データはクラウドのデータベース（例：Supabase）に保存する。
- 添付ファイルなどの大きなデータは、公開されないストレージに保管する。
- 将来的に分析が必要になった場合に備えて、外部BIツールと連携できる余地を残しておく。

## 2. 主なテーブル

### articles（記事）
- 項目例：ID、スラッグ、タイトル、リード文、本文、公開状態、公開日時、タグ、作成日時、更新日時。
- 公開状態が「公開」のものだけをサイトで表示する。

### case_studies（事例）
- 項目例：ID、スラッグ、タイトル、業種、課題、解決策、成果、要約、公開状態、作成日時、更新日時。
- 事例に紐づく画像や引用などは別テーブルで管理する。

### case_study_assets（事例の付帯情報）
- 事例ID、種類（画像・引用・数値など）、表示内容をJSON形式で保持する。
- 事例が削除されたら関連データも合わせて削除する。

### inquiries（問い合わせ）
- 項目例：ID、受付番号、目的、ステータス、氏名、メール、電話、会社名、要約、全回答、添付ファイルのキー・名前・種類、送信元、作成日時、更新日時。
- 元の回答内容はJSONで保存し、後から見直せるようにする。

### chat_logs（チャット履歴）
- 項目例：ID、セッションID、話者種別（利用者/システム/AI）、メッセージ本文、補足情報、作成日時。
- 問い合わせテーブルとセッションIDで紐づける。

### usage_stats（利用状況）
- 日付、指標の種類（ページ閲覧、CTAクリック、チャット開始など）、値、補足情報。
- ダッシュボード表示やレポート作成に利用する。

### admin_users（運営ユーザー）
- 項目例：ID、メール、権限、パスワード、最終ログイン日時。
- 権限は閲覧のみ／編集可／管理者など数種類を用意する。

## 3. 関連づけ
- 記事と利用状況は指標の種類でゆるく紐づける。
- 事例と付帯情報は1対多で紐づく。
- 問い合わせとチャット履歴はセッションIDで紐づける。
- 管理ユーザーの操作ログは別途検討する。

## 4. ファイル保存
- 添付ファイルは年月とUUIDを含むキーで保存し、同名ファイルの衝突を防ぐ。
- 保管期間を決めて定期的に整理または削除する。
- ウイルススキャンなどの安全確認は運用ルールとして実施する。

## 5. キャッシュの考え方
- 記事や事例など更新頻度の低いデータは一定時間キャッシュする。
- 問い合わせやチャットのような機密データはキャッシュしない。
- 統計データは短時間だけキャッシュしてもよいが、最新値が必要な場面は即時反映する。

## 6. アクセス制限
- 公開済みのコンテンツのみ匿名アクセスを許可し、それ以外は制限する。
- 問い合わせやチャットのデータは内部ユーザーとサーバー処理だけが触れられるようにする。
- 匿名で書き込むイベントデータは、値の正当性をサーバーで確認して取り込む。
- 制限ルールはマイグレーションなどで管理し、変更履歴を残す。

## 7. 整合性
- 問い合わせの回答データには署名やハッシュを付け、改ざんされていないか確認できるようにする。
- チャットログは時間順に並ぶように保存し、復元しやすくする。
- 外部キーや削除時の挙動はデータベースの制約を利用して管理する。

## 8. 個人情報の扱い
- 管理画面では電話番号などを部分的にマスクし、必要最小限の表示にとどめる。
- CSVなどでエクスポートできるのは権限を持つユーザーだけにし、操作ログを残す。
- 削除依頼に備え、ソフトデリートと物理削除の運用ルールを決めておく。

## 9. バックアップと復旧
- 自動バックアップとは別に、重要なタイミングでは手動でスナップショットを取得する。
- 復旧手順（新環境での復元、整合性チェック、切り戻し方法など）をドキュメント化する。

## 10. 監査ログ
- 重要なデータ操作を記録する監査ログテーブルの追加を検討する。
- API経由の更新や削除も追跡できるよう、Webhookなど補助的な仕組みを整える。

## 11. 今後の検討事項
- タグやカテゴリを別テーブルにして多言語対応や多対多の関係を扱いやすくする。
- 行動ログを蓄積し、BIツールで分析できるようにする。
- 料金プランなど繰り返し使うデータをマスターテーブルとして整理する。
